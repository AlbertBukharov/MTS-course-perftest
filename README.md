# MTS-course-perftest
Домашнее задание по нагрузочному тестированию тестового стенда

# Задача:

1. Разработать профиль нагрузки для системы  
2. Реализовать профиль на любом инструменте НТ (разработать скрипт)  
3. Задать нефункциональные требования по производительности к системе (SLO/SLA)  
4. Найти максимальную производительность системы  
5. Написать краткий вывод: где достигнута максимальная производительность, где узкое место в системе, для подтверждения привести графики.


## Подготовительная часть:  
1. Наполнить таблицу с городами и прогнозом, используя скрипты postgre_city_inserter.py и postgre_forecast_inserter.py (в Documents/MyProjects), добавим в систему 37 городов с населением более 500 тыс. человек с глубиной прогнозов в 50.  

# Решение
## Профиль нагрузки
Из предоставленного swagger'a мы получаем типовые "ручки":  
```
GET /Cities/{id}
PUT /Cities/{id}
POST /Cities  
GET /Cities  
GET /Forecast/{id}  
PUT /Forecast/{id}  
POST /Forecast/{cityID}  
GET /Forecast  
GET /WeatherForecast
```
Распишем предполагаемую частоту использования тех или иных запросов, оперируя такими количественными характеристиками как: очень редко, редко, средне, очень часто:  
```
GET /Cities/{id}  - средняя
PUT /Cities/{id}  - редкая
POST /Cities  - очень редкая
GET /Cities  - средняя  
GET /Forecast/{id}  - очень редкая (узнавать прогноз по его ID - выглядит странным)
PUT /Forecast/{id}  - очень редкая (изменение прогноза с конкретным ID выглядит несколько странным)  
POST /Forecast/{cityID}  - редкая (создание конкретного прогноза более редкое событие, чем использование)  
GET /Forecast  - редкая
GET /WeatherForecast - очень частая
```
## Реализация НТ
Описанный выше профиль реализуем с помощью Locust, скрипт представлен в виде файла locustfile.py
C учетом коэффициентов распределение запросов выглядит следующим образом:
```
GET /Cities/{id}  - 7.8%
PUT /Cities/{id}  - 1.9%
POST /Cities  - 0.4%
GET /Cities  - 7.8%
GET /Forecast/{id}  - 0.4%
PUT /Forecast/{id}  - 0.4%
POST /Forecast/{cityID}  - 1.9%
GET /Forecast  - 1.9%
GET /WeatherForecast  - 77.5%
```
## Нефункциональные требования к системе
Самыми "тяжелыми" с точки зрения времени ответа являются запросы GET /WeatherForecast и GET /Forecast, на основе полученных результатов мы можем задекларировать, что 99% запросов будут обработано не более, чем за 5 секунд

## Максимальная производительность
Максимальная производительность системы при использовании предложенного профиля нагрузки ~ 30RPS
![image](https://github.com/AlbertBukharov/MTS-course-perftest/assets/81142061/94787522-fd7c-42cd-a76b-1081680dbd18)

## Выводы
Судя по мониторингу максимальная производительность упирается в ресурсы на подах в k8s-кластере (сервис работает на 3-х подах)
![image](https://github.com/AlbertBukharov/MTS-course-perftest/assets/81142061/4420aabf-09e3-4758-a659-b4bdb67ab4e7)
При значительном превышении количества запросов система крашится с перезапуском POD'ов
Для увеличения производительности системы в целом необходимо увеличить количество POD, например, настроить Autoscaling в зависимости от CPU
